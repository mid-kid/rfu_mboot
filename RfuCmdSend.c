#if 1
__asm__("
.section .text
.global RfuCmdSend
.type RfuCmdSend, function
.thumb_func
RfuCmdSend:
.2byte 0xb530,0x4803,0x7ac0,0x2800,0xd104,0x2001,0xe053,0x0000,0x5ca0,0x0300,0x4914,0x4815,0x6800,0x6008,0x4914,0x6048,0x2001,0x7248,0x4a13,0x4b14,0x1c18,0x8010,0x1c0a,0x320c,0x7810,0x2800,0xd0fc,0x7b4a,0x1e50,0x0600,0x0e00,0x2801,0xd81c,0x2400,0x7b88,0x4284,0xda06,0x1c0d,0xf001,0xffa6,0x3401,0x7baa,0x4294,0xdbf9,0x4c05,0x7b65,0xf7ff,0xff94,0x7365,0x2002,0x72a0,0xe7d5,0x0120,0x0400,0x5cc0,0x0300,0x5ca0,0x0300,0x0128,0x0400,0x5083,0x0000,0x0610,0x0e00,0x2803,0xd117,0x490d,0x2380,0x021b,0x1c18,0x8008,0x4a0c,0x1c10,0x24fa,0x00a4,0x8008,0x3c01,0x2c00,0xd1fb,0x4907,0x2380,0x021b,0x1c18,0x8008,0x2000,0x8008,0x390c,0x4a05,0x1c10,0x8008,0x2000,0xbc30,0xbc02,0x4708,0x0134,0x0400,0x80ff,0x0000,0x5003,0x0000
.size RfuCmdSend, .-RfuCmdSend
");
#else

#include <Agb.h>

#include "Rfu.h"
extern u32 RfuCmdInit(void);
extern struct Rfu Rfu;
extern u8 RfuBufSend[0x120];

u16 RfuCmdSend(void)
{
    int x;
    u8 tmp;
    u8 *ptr8;
    u16 val;

    if (!Rfu.modeMaster) return 1;

retry:
    *(vu32 *)REG_SIODATA32 = *(u32 *)RfuBufSend;
    Rfu.cmdHeader = *(u32 *)RfuBufSend;
    Rfu.field3_0x9 = 1;
    *(vu16 *)REG_SIOCNT = 0x5083;

    ptr8 = &Rfu.unk_07;
wait:
    if (*ptr8 == 0) goto wait;

    if ((u8)(Rfu.unk_08 - 1) <= 1) {
        for (x = 0; x < Rfu.unk_09; x++) VBlankIntrWait();

        tmp = Rfu.unk_08;
        RfuCmdInit();
        Rfu.unk_08 = tmp;
        Rfu.error = 2;
        goto retry;
    }

    if (Rfu.unk_08 != 3) return 0;

    *(vu16 *)REG_RCNT = 0x8000;
    val = 0x80ff;
    for (x = 1000; x; x--) *(u16 *)REG_RCNT = val;
    *(vu16 *)REG_RCNT = 0x8000;
    val = 0;

    *(vu16 *)REG_RCNT = 0;
    *(vu16 *)REG_SIOCNT = 0x5003;

    return 0;
}

#endif
